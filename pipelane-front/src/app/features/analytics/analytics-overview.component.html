<div class="page">
  <div class="container-page analytics-page">
    <app-page-header
      title="Analytics dashboard"
      [subtitle]="'Observing ' + (rangeSummary() || 'â€”')"
    >
      <div page-actions class="analytics-controls glass" plRevealOnScroll="fade-up">
        <div class="preset-buttons">
          <button
            mat-stroked-button
            *ngFor="let preset of presetItems"
            [class.active]="rangePreset() === preset.key"
            (click)="selectPreset(preset.key)"
            [disabled]="loading() && rangePreset() === preset.key"
            [matTooltip]="preset.tooltip"
            [attr.data-cy]="'preset-' + preset.key"
          >
            {{ preset.label }}
          </button>
        </div>
        <mat-form-field appearance="outline" class="range-field" floatLabel="always">
          <mat-label>Custom range</mat-label>
          <mat-date-range-input [formGroup]="dateRange">
            <input matStartDate formControlName="start" placeholder="Start date" />
            <input matEndDate formControlName="end" placeholder="End date" />
          </mat-date-range-input>
          <mat-datepicker-toggle matSuffix [for]="picker"></mat-datepicker-toggle>
          <mat-date-range-picker #picker></mat-date-range-picker>
        </mat-form-field>
        <button
          mat-flat-button
          color="primary"
          class="export-button"
          (click)="downloadSummary()"
          [disabled]="loading() || exporting()"
          matTooltip="Download a PDF summary for the selected range"
          data-tour="analytics-export"
        >
          <mat-icon aria-hidden="true">picture_as_pdf</mat-icon>
          <span>Export PDF</span>
        </button>
      </div>
    </app-page-header>

    <section
      class="kpi-grid anim-stagger"
      *ngIf="kpis().length; else kpiSkeleton"
      plRevealOnScroll="stagger"
    >
      <pl-kpi-card
        *ngFor="let kpi of kpis(); trackBy: trackKpi"
        [label]="kpi.label"
        [caption]="kpi.caption"
        [value]="kpi.value"
        [valueFormat]="kpi.valueFormat || '1.0-0'"
        [prefix]="kpi.prefix"
        [suffix]="kpi.suffix"
        [icon]="kpi.icon"
        [tooltip]="kpi.tooltip"
        [delta]="kpi.delta"
        [deltaLabel]="kpi.deltaLabel"
        [sparkline]="kpi.sparkline"
        [loading]="loading()"
      ></pl-kpi-card>
    </section>

    <ng-template #kpiSkeleton>
      <section class="kpi-grid skeleton" plRevealOnScroll="stagger">
        <div class="kpi-skeleton glass" *ngFor="let placeholder of [1, 2, 3, 4, 5]">
          <div class="kpi-skeleton__icon"></div>
          <div class="kpi-skeleton__label"></div>
          <div class="kpi-skeleton__value"></div>
          <div class="kpi-skeleton__sparkline"></div>
        </div>
      </section>
    </ng-template>

    <section class="charts-grid" plRevealOnScroll="fade-up">
      <pl-chart-card
        *ngIf="areaChart() as area"
        [config]="area"
        data-cy="timeline-chart"
      ></pl-chart-card>
      <pl-chart-card *ngIf="channelDonut() as donut" [config]="donut"></pl-chart-card>
      <pl-chart-card *ngIf="templateBar() as bar" [config]="bar"></pl-chart-card>
    </section>

    <section class="error-state" *ngIf="error()">
      <mat-card class="error-card glass">
        <mat-icon aria-hidden="true">error_outline</mat-icon>
        <div>
          <h3>We hit turbulence</h3>
          <p>{{ error() }}</p>
          <button mat-stroked-button color="primary" (click)="retry()">Retry</button>
        </div>
      </mat-card>
    </section>

    <mat-card class="table-card glass" plRevealOnScroll="fade-up">
      <div class="table-card__header">
        <div>
          <h3>Channel delivery summary</h3>
          <p class="muted">Compare throughput and reliability by provider</p>
        </div>
        <mat-progress-spinner
          *ngIf="loading()"
          diameter="28"
          mode="indeterminate"
        ></mat-progress-spinner>
      </div>
      <div class="table-wrapper">
        <table mat-table [dataSource]="table" matSort class="delivery-table">
          <ng-container matColumnDef="channel">
            <th mat-header-cell *matHeaderCellDef mat-sort-header>Channel</th>
            <td mat-cell *matCellDef="let row">
              <div class="channel-cell">
                <span class="channel-icon material-symbols-rounded">
                  {{
                    row.channel === 'email' ? 'mail' : row.channel === 'whatsapp' ? 'chat' : 'sms'
                  }}
                </span>
                <span>{{ row.label }}</span>
              </div>
            </td>
          </ng-container>

          <ng-container matColumnDef="sent">
            <th mat-header-cell *matHeaderCellDef mat-sort-header>Sent</th>
            <td mat-cell *matCellDef="let row">{{ row.sent | number }}</td>
          </ng-container>

          <ng-container matColumnDef="delivered">
            <th mat-header-cell *matHeaderCellDef mat-sort-header>Delivered</th>
            <td mat-cell *matCellDef="let row">{{ row.delivered | number }}</td>
          </ng-container>

          <ng-container matColumnDef="opened">
            <th mat-header-cell *matHeaderCellDef mat-sort-header>Opened</th>
            <td mat-cell *matCellDef="let row">{{ row.opened | number }}</td>
          </ng-container>

          <ng-container matColumnDef="failed">
            <th mat-header-cell *matHeaderCellDef mat-sort-header>Failed</th>
            <td mat-cell *matCellDef="let row">
              <span matTooltip="Includes hard failures and bounces">{{
                row.failed + row.bounced | number
              }}</span>
            </td>
          </ng-container>

          <ng-container matColumnDef="successRate">
            <th mat-header-cell *matHeaderCellDef mat-sort-header>Success %</th>
            <td mat-cell *matCellDef="let row">
              <span class="badge badge--success">{{ row.successRate | number: '1.0-1' }}%</span>
            </td>
          </ng-container>

          <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
          <tr mat-row *matRowDef="let row; columns: displayedColumns"></tr>
        </table>
      </div>
      <mat-paginator
        [pageSize]="5"
        [pageSizeOptions]="[5, 10, 20]"
        showFirstLastButtons
      ></mat-paginator>
    </mat-card>
  </div>
</div>
