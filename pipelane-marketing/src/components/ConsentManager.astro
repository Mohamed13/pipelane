---
const gaId = import.meta.env.PUBLIC_GA_ID ?? "";
const linkedinId = import.meta.env.PUBLIC_LINKEDIN_ID ?? "";
const bannerMessage = "Nous utilisons des cookies pour mesurer l’audience et améliorer nos campagnes.";
---
<div
  class="fixed left-[clamp(8px,3vw,24px)] right-[clamp(8px,3vw,24px)] bottom-[max(8px,var(--safe-bottom))] z-[var(--z-banner)]"
  data-consent-banner
  hidden
>
  <div
    role="dialog"
    aria-live="polite"
    tabindex="-1"
    class="glass pointer-events-auto max-w-2xl rounded-3xl border border-white/12 bg-surfaceOverlay/95 p-5 shadow-soft"
  >
    <div class="flex flex-col gap-4 text-sm leading-relaxed on-surface md:flex-row md:items-center md:justify-between">
      <p>{bannerMessage}</p>
      <div class="flex shrink-0 gap-3">
        <button type="button" class="btn-primary min-h-[44px] rounded-xl px-5" data-consent-accept>Accepter</button>
        <button type="button" class="btn-ghost min-h-[44px] rounded-xl px-5" data-consent-reject>Refuser</button>
      </div>
    </div>
  </div>
</div>
<script is:inline data-ga={gaId} data-linkedin={linkedinId}>
  (() => {
    const scriptEl = document.currentScript;
    const gaId = scriptEl?.dataset.ga ?? '';
    const linkedinId = scriptEl?.dataset.linkedin ?? '';
    const storageKey = 'pipelane_consent';
    const banner = document.querySelector('[data-consent-banner]');
    const acceptBtn = document.querySelector('[data-consent-accept]');
    const rejectBtn = document.querySelector('[data-consent-reject]');

    const applySafePadding = () => {
      document.body.style.paddingBottom = 'calc(16px + var(--safe-bottom, 0px))';
    };

    const resetSafePadding = () => {
      document.body.style.paddingBottom = '';
    };

    const showBanner = () => {
      if (!(banner instanceof HTMLElement)) return;
      banner.hidden = false;
      applySafePadding();
      requestAnimationFrame(() => {
        (acceptBtn instanceof HTMLElement ? acceptBtn : null)?.focus({ preventScroll: true });
      });
    };

    const dismissBanner = () => {
      resetSafePadding();
      if (banner instanceof HTMLElement) {
        banner.remove();
      }
    };

    const loadScripts = () => {
      if (window.__pipelaneTagsLoaded) return;
      window.__pipelaneTagsLoaded = true;
      if (gaId) {
        window.dataLayer = window.dataLayer || [];
        window.dataLayer.push({ js: new Date() });
        window.dataLayer.push({ config: gaId });
        const script = document.createElement('script');
        script.async = true;
        script.src = `https://www.googletagmanager.com/gtag/js?id=${encodeURIComponent(gaId)}`;
        document.head.appendChild(script);
        const inline = document.createElement('script');
        inline.text = [
          'window.dataLayer = window.dataLayer || [];',
          'function gtag(){dataLayer.push(arguments);}',
          "gtag('js', new Date());",
          `gtag('config', ${JSON.stringify(gaId)});`,
        ].join('\n');
        document.head.appendChild(inline);
      }
      if (linkedinId) {
        const partner = document.createElement('script');
        partner.type = 'text/javascript';
        partner.text = [
          'window._linkedin_data_partner_ids = window._linkedin_data_partner_ids || [];',
          `window._linkedin_data_partner_ids.push(${JSON.stringify(linkedinId)});`,
        ].join('\n');
        document.head.appendChild(partner);
        const loader = document.createElement('script');
        loader.type = 'text/javascript';
        loader.async = true;
        loader.src = 'https://snap.licdn.com/li.lms-analytics/insight.min.js';
        document.head.appendChild(loader);
      }
    };

    const stored = localStorage.getItem(storageKey);
    if (stored === 'accepted') {
      loadScripts();
    } else if (stored === 'rejected') {
      // rien
    } else if (banner) {
      showBanner();
    }

    acceptBtn?.addEventListener('click', () => {
      localStorage.setItem(storageKey, 'accepted');
      dismissBanner();
      loadScripts();
    });

    rejectBtn?.addEventListener('click', () => {
      localStorage.setItem(storageKey, 'rejected');
      dismissBanner();
    });
  })();
</script>
