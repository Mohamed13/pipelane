---
import type { DemoFormDictionary } from "@utils/i18n";
import { DEFAULT_LOCALE, getTranslations } from "@utils/i18n";

interface Props {
  idPrefix: string;
  compact?: boolean;
  submitLabel?: string;
  copy?: DemoFormDictionary;
}

const defaultCopy = getTranslations(DEFAULT_LOCALE).forms.demo;

const {
  idPrefix,
  compact = false,
  submitLabel,
  copy = defaultCopy
} = Astro.props as Props;

const resolvedSubmitLabel = submitLabel ?? copy.submit;

const inputClasses = "w-full rounded-2xl border border-line/35 bg-surfaceOverlay px-4 py-3 text-base on-surface-strong outline-none transition focus:border-primary focus:ring-2 focus:ring-primary/40";
const selectClasses = `${inputClasses} appearance-none`;
const containerClasses = compact ? "grid gap-4 sm:grid-cols-2" : "grid gap-5";
const notesClasses = compact ? "sm:col-span-2" : "";
const footerClasses = compact ? "flex flex-col gap-3 sm:col-span-2 sm:flex-row sm:items-center" : "flex flex-col gap-3";
---
<form
  data-demo-form
  method="post"
  action="/api/demo-request"
  class={containerClasses}
  novalidate
  data-status-sending={copy.status.sending}
  data-status-success={copy.status.success}
  data-status-error={copy.status.error}
  data-status-generic-error={copy.status.genericError}
>
  <div class="grid gap-2">
    <label class="text-sm font-medium on-surface" for={`${idPrefix}-name`}>{copy.labels.name}</label>
    <input
      id={`${idPrefix}-name`}
      name="name"
      type="text"
      required
      placeholder={copy.placeholders.name}
      class={inputClasses}
    />
  </div>
  <div class="grid gap-2">
    <label class="text-sm font-medium on-surface" for={`${idPrefix}-email`}>{copy.labels.email}</label>
    <input
      id={`${idPrefix}-email`}
      name="email"
      type="email"
      required
      placeholder={copy.placeholders.email}
      class={inputClasses}
    />
  </div>
  <div class="grid gap-2">
    <label class="text-sm font-medium on-surface" for={`${idPrefix}-company`}>{copy.labels.company}</label>
    <input
      id={`${idPrefix}-company`}
      name="company"
      type="text"
      required
      placeholder={copy.placeholders.company}
      class={inputClasses}
    />
  </div>
  <div class="grid gap-2">
    <label class="text-sm font-medium on-surface" for={`${idPrefix}-volume`}>{copy.labels.volume}</label>
    <select id={`${idPrefix}-volume`} name="volume" required class={selectClasses}>
      <option value="">{copy.volume.placeholder}</option>
      {copy.volume.options.map((option) => (
        <option value={option.value}>{option.label}</option>
      ))}
    </select>
  </div>
  <div class={`grid gap-2 ${notesClasses}`}>
    <label class="text-sm font-medium on-surface" for={`${idPrefix}-notes`}>{copy.labels.message}</label>
    <textarea
      id={`${idPrefix}-notes`}
      name="notes"
      rows={compact ? 3 : 4}
      placeholder={copy.placeholders.message}
      class={inputClasses}
    ></textarea>
  </div>
  <input type="hidden" name="utm_source" />
  <input type="hidden" name="utm_medium" />
  <input type="hidden" name="utm_campaign" />
  <input type="hidden" name="gclid" />
  <input type="hidden" name="fbclid" />
  <div class={footerClasses}>
    <button
      type="submit"
      class="btn-primary flex-1 justify-center"
      data-demo-submit
      data-analytics="demo_submit"
    >
      {resolvedSubmitLabel}
    </button>
    <p data-demo-status class="text-sm text-textMuted"></p>
    <div class="text-xs uppercase tracking-[0.3em] text-textMuted">{copy.disclaimer}</div>
  </div>
</form>
<script is:inline>
  (() => {
    if (window.__pipelaneDemoFormLoaded) return;
    window.__pipelaneDemoFormLoaded = true;
    const params = new URLSearchParams(window.location.search);

    const fillUtm = (form) => {
      ["utm_source", "utm_medium", "utm_campaign", "gclid", "fbclid"].forEach((key) => {
        const input = form.querySelector(`input[name="${key}"]`);
        if (input && !input.value) {
          input.value = params.get(key) ?? "";
        }
      });
    };

    const forms = Array.from(document.querySelectorAll('[data-demo-form]'));
    forms.forEach((form) => {
      const status = form.querySelector('[data-demo-status]');
      const submit = form.querySelector('[data-demo-submit]');
      fillUtm(form);
      const sendingText = form.dataset.statusSending || 'Envoi…';
      const successText = form.dataset.statusSuccess || 'Merci, on revient vers vous sous 24 h.';
      const errorText = form.dataset.statusError || "Impossible d’envoyer le formulaire.";
      const genericErrorText = form.dataset.statusGenericError || errorText;

      form.addEventListener('submit', async (event) => {
        event.preventDefault();
        const formData = new FormData(form);
        submit?.setAttribute('disabled', 'true');
        submit?.classList.add('opacity-70', 'cursor-wait');
        if (status) {
          status.textContent = sendingText;
          status.classList.remove('text-primary', 'text-red-400');
          status.classList.add('text-textMuted');
        }
        try {
          const response = await fetch('/api/demo-request', {
            method: 'POST',
            body: formData
          });
          const payload = await response.json().catch(() => ({}));
          if (response.ok) {
            if (status) {
              status.textContent = successText;
              status.classList.remove('text-textMuted');
              status.classList.add('text-primary');
            }
            form.reset();
            fillUtm(form);
            window.dataLayer = window.dataLayer || [];
            window.dataLayer.push({
              event: 'demo_submit',
              company: formData.get('company') || '',
              volume: formData.get('volume') || '',
              utm_source: formData.get('utm_source') || ''
            });
          } else {
            if (status) {
              status.textContent = payload?.error ?? errorText;
              status.classList.remove('text-textMuted');
              status.classList.add('text-red-400');
            }
          }
        } catch (error) {
          if (status) {
            status.textContent = genericErrorText;
            status.classList.remove('text-textMuted');
            status.classList.add('text-red-400');
          }
        } finally {
          submit?.removeAttribute('disabled');
          submit?.classList.remove('opacity-70', 'cursor-wait');
        }
      });
    });
  })();
</script>
